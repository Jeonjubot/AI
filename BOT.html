<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <meta property="og:image" content="./ì´ë¯¸ì§€/profile.png" />
  <title>KT MOS ë‚¨ë¶€</title>
  <style>
    body {
      font-family: 'Apple SD Gothic Neo', sans-serif;
      background-color: #c7dbe6;
      margin: 0;
      padding: 0;
      font-size: 17px;
    }
    .chat-container { max-width: 504px; margin: auto; height: 100dvh; display: flex; flex-direction: column; }
    .chat-box { flex: 1; overflow-y: auto; padding: 12px; }
    .message { display: flex; margin: 12px 0; align-items: flex-start; }
    .message.bot { justify-content: flex-start; align-items: flex-start; }
    .message.user { justify-content: flex-end; }
    .bubble { max-width: 100%; padding: 12px 17px; border-radius: 24px; font-size: 17px; background: #fff; }
    .bot .bubble { border-top-left-radius: 0; }
    .user .bubble { border-top-right-radius: 0; }
    .avatar { width: 46px; height: 46px; border-radius: 50%; margin-right: 10px; }
    .name { font-size: 14px; color: #444; margin-bottom: 3px; margin-left: 5px; }
    .input-area { padding: 12px; border-top: 1px solid #ddd; background: #fff; display: flex; }
    .input-area input {
      flex: 1;
      padding: 12px;
      font-size: 17px;
      border: 1px solid #ccc;
      border-radius: 24px;
      outline: none;
    }
    .input-area button {
      background: none;
      border: none;
      padding: 0;
      margin-left: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
    }
    .send-button img {
      height: 40px;
    }
  </style>
</head>
<body>
  <div class="chat-container">
    <div class="chat-box" id="chatWindow"></div>
    <div class="input-area">
      <input id="input" type="text" placeholder="ë©”ì‹œì§€ ì…ë ¥" />
      <button onclick="handleSend()" class="send-button">
        <img src="./ì´ë¯¸ì§€/send.png" alt="ì „ì†¡" />
      </button>
    </div>
  </div>

<script>
  let chatData = [], currentNode = null;
  const currentCode = "000000";
  let previousHeight = window.innerHeight;

  let userAnswers = []; // ì „ì²´ ì‘ë‹µ ê¸°ë¡
  let userRating = 0;   // ë³„ì  ê°’ ì €ì¥

  function showMessage(text, isUser = false, scroll = true) {
    const chat = document.getElementById("chatWindow");
    const msgWrapper = document.createElement("div");
    msgWrapper.className = "message " + (isUser ? "user" : "bot");

    if (!isUser) {
      const avatar = document.createElement("img");
      avatar.className = "avatar";
      avatar.src = "./ì´ë¯¸ì§€/profile.png";

      const content = document.createElement("div");
      const name = document.createElement("div");
      name.className = "name";
      name.textContent = "KT MOS ë‚¨ë¶€";

      const bubble = document.createElement("div");
      bubble.className = "bubble";
      bubble.innerHTML = text.replace(/\n/g, "<br>");

      content.appendChild(name);
      content.appendChild(bubble);
      msgWrapper.appendChild(avatar);
      msgWrapper.appendChild(content);
    } else {
      const bubble = document.createElement("div");
      bubble.className = "bubble";
      bubble.innerHTML = text.replace(/\n/g, "<br>");
      msgWrapper.appendChild(bubble);
    }

    chat.appendChild(msgWrapper);
    if (scroll) requestAnimationFrame(() => {
      const last = chat.querySelector(".message:last-child");
      if (last) last.scrollIntoView({ behavior: "smooth", block: "end" });
    });
  }

  function showOptions(options) {
    const chat = document.getElementById("chatWindow");
    const optionWrapper = document.createElement("div");
    optionWrapper.className = "message bot";
    optionWrapper.style.width = "100%";

    const btnGroup = document.createElement("div");
    btnGroup.style.display = "flex";
    btnGroup.style.flexDirection = "column";
    btnGroup.style.alignItems = "center";
    btnGroup.style.gap = "12px";
    btnGroup.style.marginTop = "8px";
    btnGroup.style.width = "100%";

    options.forEach(opt => {
      const btn = document.createElement("button");
      btn.innerHTML = `
        <div style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
          <span style="flex: 0 0 30px; text-align: left;">${opt.ë²ˆí˜¸}.</span>
          <span style="flex: 1; text-align: center;">${opt.ë‚´ìš©}</span>
          <span style="flex: 0 0 30px;"></span>
        </div>
      `;
      btn.style.padding = "16px 18px";
      btn.style.fontSize = "24px";
      btn.style.border = "none";
      btn.style.borderRadius = "24px";
      btn.style.background = "#fbeec0";
      btn.style.cursor = "pointer";
      btn.style.boxShadow = "0 2px 6px rgba(0,0,0,0.15)";
      btn.style.width = "100%";
      btn.style.maxWidth = "360px";
      btn.style.margin = "0 auto";

      btn.onclick = () => {
        document.getElementById("input").value = opt.ë²ˆí˜¸;
        handleSend();
      };

      btnGroup.appendChild(btn);
    });

    optionWrapper.appendChild(btnGroup);
    chat.appendChild(optionWrapper);
    requestAnimationFrame(() => {
      optionWrapper.scrollIntoView({ behavior: "smooth", block: "end" });
    });
  }

  async function showImageFirst(imageName) {
    const imagePath = `./ì´ë¯¸ì§€/${currentCode}/${imageName}.png`;
    try {
      const res = await fetch(imagePath);
      if (res.ok) {
        showMessage(`<img src="${imagePath}" style="max-width:100%; border-radius:12px;">`, false, true);
        return true;
      }
    } catch {}
    return false;
  }

  async function showVideoFirst(videoName) {
    const videoPath = `./ì˜ìƒ/${currentCode}/${videoName}.mp4`;
    try {
      const res = await fetch(videoPath);
      if (res.ok) {
        showMessage(
          `<video controls style="max-width:100%; border-radius:12px;">
            <source src="${videoPath}" type="video/mp4">
            ì´ ë¸Œë¼ìš°ì €ëŠ” video íƒœê·¸ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
          </video>`,
          false,
          true
        );
        return true;
      }
    } catch {}
    return false;
  }

  async function showQuestion(id) {
    currentNode = chatData.find(d => d.ID === id);
    if (!currentNode) return;

    if (currentNode.ì´ë¯¸ì§€) {
      await showImageFirst(currentNode.ì´ë¯¸ì§€);
      await new Promise(resolve => setTimeout(resolve, 400));
    }

    if (currentNode.ì˜ìƒ) {
      await showVideoFirst(currentNode.ì˜ìƒ);
      await new Promise(resolve => setTimeout(resolve, 400));
    }

    showMessage(currentNode.ì§ˆë¬¸ë‚´ìš©);

    if (currentNode.ì„ íƒì§€ && currentNode.ì„ íƒì§€.length > 0) {
      showOptions(currentNode.ì„ íƒì§€);
    }
  }

  async function handleSend() {
    const input = document.getElementById("input");
    const val = input.value.trim();
    if (!val) return;

    showMessage(val, true);
    userAnswers.push(`${currentNode?.ID}:${val}`);
    input.value = "";

    const number = parseInt(val, 10);
    const isImageTarget = isNaN(number) || number > 20;
    let imageShown = false;

    if (isImageTarget) {
      const imagePath = `./ì´ë¯¸ì§€/${currentCode}/${val}.png`;
      try {
        const res = await fetch(imagePath);
        if (res.ok) {
          showMessage(`<img src="${imagePath}" style="max-width:100%; border-radius:12px;">`);
          imageShown = true;
        }
      } catch {}
    }

    if (!currentNode) return;

    const next = currentNode.ì„ íƒì§€.find(opt => opt.ë²ˆí˜¸ === val);
    if (next) {
      if (next.ë‹¤ìŒID === "END") {
        showRating();
      } else {
        showQuestion(next.ë‹¤ìŒID);
      }
    } else if (!imageShown) {
      showMessage("ì˜¬ë°”ë¥¸ ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
    }
  }

  function showRating() {
    const chat = document.getElementById("chatWindow");

    const wrapper = document.createElement("div");
    wrapper.className = "message bot";
    wrapper.innerHTML = `
      <div style="margin-bottom: 8px;">ğŸ’¬ ì„œë¹„ìŠ¤ëŠ” ì–¼ë§ˆë‚˜ ë§Œì¡±ìŠ¤ëŸ¬ìš°ì…¨ë‚˜ìš”?</div>
      <div id="starContainer" style="display: flex; gap: 6px; margin-bottom: 12px;">
        ${[1,2,3,4,5].map(n => `
          <img src="./ì´ë¯¸ì§€/star-empty.png" onclick="selectStar(${n})" id="star-${n}" style="width: 40px; cursor: pointer;">
        `).join('')}
      </div>
      <button onclick="submitRating()" style="padding: 10px 20px; font-size: 16px; border: none; border-radius: 8px; background: #007bff; color: white; cursor: pointer;">í™•ì¸</button>
    `;
    chat.appendChild(wrapper);
    wrapper.scrollIntoView({ behavior: "smooth", block: "end" });
  }

  function selectStar(n) {
    userRating = n;
    for (let i = 1; i <= 5; i++) {
      document.getElementById(`star-${i}`).src = i <= n ? './ì´ë¯¸ì§€/star-filled.png' : './ì´ë¯¸ì§€/star-empty.png';
    }
  }

  async function submitRating() {
    if (userRating === 0) {
      alert("ë³„ì ì„ ì„ íƒí•´ì£¼ì„¸ìš”!");
      return;
    }

    const payload = {
      timestamp: new Date().toISOString(),
      regionCode: currentCode,
      answers: userAnswers.join(", "),
      rating: userRating
    };

    try {
      const res = await fetch("https://script.google.com/macros/s/AKfycbwxntNUetOSuH8jttAKIXjtlAs_ccgOSu-MZ9RA_bnWrt2XgVx6H6xOoMmYeC5GHGgn/exec", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      if (res.ok) {
        showMessage("ğŸ‰ ê°ì‚¬í•©ë‹ˆë‹¤! ì†Œì¤‘í•œ í‰ê°€ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
      } else {
        showMessage("âŒ ì €ì¥ ì‹¤íŒ¨. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
      }
    } catch (err) {
      showMessage("âš ï¸ ì˜¤ë¥˜ ë°œìƒ: " + err.message);
    }
  }

  document.getElementById("input").addEventListener("keydown", e => {
    if (e.key === "Enter") handleSend();
  });

  (async () => {
    try {
      const res = await fetch(`./ì½”ë“œ/${currentCode}.json`);
      if (!res.ok) throw new Error("ì§€ì—­ì½”ë“œ ë°ì´í„° ì—†ìŒ");
      chatData = await res.json();

      showMessage("ğŸ™‚ ì•ˆë…•í•˜ì„¸ìš”. ê³ ê°ë‹˜!!\nğŸ˜˜ ê³ ê° ì¤‘ì‹¬ì˜ ì„œë¹„ìŠ¤ì™€\nğŸ˜ í˜ì‹ ì„ ì„ ë„í•˜ëŠ” íŒŒíŠ¸ë„ˆ\nğŸ˜Š KT MOS ë‚¨ë¶€ì…ë‹ˆë‹¤.");
      await new Promise(resolve => setTimeout(resolve, 800));
      showQuestion("Q1");
    } catch {
      showMessage("âŒ ì§€ì—­ì½”ë“œ ë°ì´í„°ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
    }
  })();

  window.addEventListener("resize", () => {
    const currentHeight = window.innerHeight;
    const chat = document.getElementById("chatWindow");
    if (currentHeight < previousHeight) {
      chat.scrollTop = chat.scrollHeight;
    }
    previousHeight = currentHeight;
  });
</script>
</body>
</html>
